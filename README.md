# kube-aws-kubeadm
To start, reusing the Terraform templates that get generated by `kops create cluster` and removing the `user_data` in `master` and `node` `aws_instance`

## Master and Node
* `docker` 1.12.x and run as `systemd` service

  Download
  ```
  curl -kL https://get.docker.com/builds/Linux/x86_64/docker-1.12.6.tgz --output docker.tar.gz
  ```
  Configure `systemd` service: `/etc/systemd/system/docker.service`
  ```
  [Service]
  ExecStart=/usr/local/bin/dockerd
  ExecReload=/bin/kill -s HUP $MAINPID
  KillMode=process
  ```
  **Note:** Above is just a bare minimum. Look at how `kops` does this (`nodeup/pkg/model/docker.go`)

  IMPORTANT
  ```
  sudo groupadd docker
  ```

  Run
  ```
  sudo systemctl start docker
  ```
* `kubeadm` and `kubectl`
  ```
  sudo apt-get update && sudo apt-get install -y apt-transport-https
  sudo curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
  sudo cat <<EOF > /etc/apt/sources.list.d/kubernetes.list
  deb http://apt.kubernetes.io/ kubernetes-xenial main
  ```
  From `apt-get install -y kubeadm kubelet`:
  * Setting up `ebtables` (2.0.10.4-3.4ubuntu2) ...
  * Setting up `kubernetes-cni` (0.5.1-00) ...
  * Setting up `socat` (1.7.3.1-1) ...
  * Setting up `kubelet` (1.7.0-00) ...
  * Setting up `kubectl` (1.7.0-00) ...
  * Setting up `kubeadm` (1.7.0-00) ...

## Master
* Reset the hostname: `sudo hostname $(hostname -f)` (https://github.com/kubernetes/kubeadm/issues/330)
* `kubeadm.yaml`
  ```yaml
  apiVersion: kubeadm.k8s.io/v1alpha1
  kind: MasterConfiguration
  cloudProvider: aws
  ```
  Run `kubeadm init --config=kubeadm.yaml`
* Drop in a file as `/etc/systemd/system/kubelet.service.d/20-cloud-provider.conf` containing:
  ```
  [Service]
  Environment="KUBELET_EXTRA_ARGS=--cloud-provider=aws"
  ```
* Delete KUBELET_NETWORKING_ARGS
* `kubectl apply` to https://github.com/kubernetes/kubeadm/issues/335#issuecomment-312962574

## Node
* `kubeadm join --token <xx> <master>:<port>`