# kube-aws-kubeadm
To start, reusing the Terraform templates that get generated by `kops create cluster` and removing the `user_data` in `master` and `node` `aws_instance`

## Master and Node
**Note:** kubeadm and kubelet 1.7.0, docker 1.12.6
```
sudo apt-get update && sudo apt-get install -y apt-transport-https

sudo curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -

sudo cat <<EOF > /etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF

sudo apt-get install -y docker.io

sudo apt-get install -y kubeadm kubelet
```

## Master
* Reset the hostname: `sudo hostname $(hostname -f)` (https://github.com/kubernetes/kubeadm/issues/330)
* `kubeadm.yaml`
  ```yaml
  apiVersion: kubeadm.k8s.io/v1alpha1
  kind: MasterConfiguration
  cloudProvider: aws
  ```
  Run `kubeadm init --config=kubeadm.yaml`
* Drop in a file as `/etc/systemd/system/kubelet.service.d/20-cloud-provider.conf` containing:
  ```
  [Service]
  Environment="KUBELET_EXTRA_ARGS=--cloud-provider=aws"
  ```
* Delete KUBELET_NETWORKING_ARGS `/etc/systemd/system/kubelet.service.d/10-kubeadm.conf`
* `sudo systemctl daemon-reload`
* `kubectl apply` for https://github.com/kubernetes/kubeadm/issues/335#issuecomment-312962574
* `kubectl create -f calico.yaml`

## Node
* `sudo hostname $(hostname -f)`
* `kubeadm join --token <xx> <master>:<port>`